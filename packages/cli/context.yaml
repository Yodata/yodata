$schema: 'https://realestate.yodata.me/context/v1/schema.yaml'
id: 'https://ace-dev.bhhs.hsfaffiliates.com/public/context/stage/outbound-salesforce-marketingprogram-create.cdef.yaml'
'@view': |
  {
      "topic": topic,
      "data": {
          "ReportWrapper": {
              "Report": {
                  "Name": data.object.name,
                  "Report_ID__c": data.object.identifier.buysideid,
                  "Description__c": data.object.name,
                  "Type__c": "Buyer",
                  "Street__c": data.object.about.address.streetAddress,
                  "City__c": data.object.about.address.addressLocality,
                  "State__c": data.object.about.address.addressRegion,
                  "PostalCode__c": data.object.about.address.postalCode
              },
              "User": {
                  "HSF_ID__c": $substringAfter($substringBefore($substringAfter(data.agent,"//"), "."), "-")
              }
          },
          "SubscriptionWrappers": [
              $map(data.object.member, function($v, $i, $a) {
                  {
                      "Subscription": {
                          "Name": $v.name & " - " & data.object.name,
                          "Agent__r": {
                              "HSF_ID__c": $substringAfter($substringBefore($substringAfter(data.agent,"//"), "."), "-")
                          },
                          "Contact__r": {
                              "Reflex_Derived_Id__c": $substringAfter($substringBefore($substringAfter(data.agent,"//"), "."), "-") & "|" & data.object.identifier.buysideid
                          },
                          "Report__r": {
                              "Report_ID__c": data.object.identifier.buysideid
                          },
                          "Status__c": "Subscribed",
                          "Subscription_ID__c": data.object.identifier.buysideid & "|" & $v.identifier.buysideid
                      },
                      "User": {
                          "HSF_ID__c": $substringAfter($substringBefore($substringAfter(data.agent,"//"), "."), "-")
                      }
                  }
              })
          ],
          "ContactWrappers": [
              $map(data.object.member, function($v, $i, $a) {
                  {
                      "Contact": {
                          "Reflex_Derived_ID__c": $substringAfter($substringBefore($substringAfter(data.agent,"//"), "."), "-") & "|" & data.object.identifier.buysideid,
                          "Email": $v.identifier.buysideid,
                          "Name": "",
                          "FirstName": "",
                          "LastName": "",
                          "Phone": "",
                          "Fax": "",
                          "Title": "",
                          "MailingCity": "",
                          "MailingState": "",
                          "MailingCountry": "",
                          "MailingPostalCode": "",
                          "MailingStreet": ""
                      },
                      "User": {
                          "HSF_ID__c": $substringAfter($substringBefore($substringAfter(data.agent,"//"), "."), "-")
                      }
                  }
              })
          ]
      }
  }
